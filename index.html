<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Prospect 3 â€” Interactive Flipbook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="styles.css" rel="stylesheet" />
  <link href="extras.css" rel="stylesheet" />
</head>
<body>

  <!-- Global audio (background music) -->
  <audio id="bgMusic" loop preload="auto">
    <!-- Replace with your chosen track when available -->
    <source src="assets/music/soft-ambient.mp3" type="audio/mpeg" />
  </audio>

  <!-- Top bar -->
  <header class="topbar">
    <div class="left-controls">
      <button class="btn glow-btn" id="musicBtn" aria-label="Play/Pause music">â™« Music</button>
    </div>
    <div class="brand-title">Prospect 3 â€” Interactive Flipbook</div>
    <div class="right-controls">
      <button class="btn outline-btn" id="helpBtn" aria-label="Help">Help</button>
    </div>
  </header>

  <!-- Start screen -->
  <section class="start-screen" id="startScreen">
    <div class="start-card">
      <h1 class="title">English for Schools â€” Prospect 3</h1>
      <p class="subtitle">Lessons, practice, workbook, audio, photo dictionary, exams</p>

      <!-- Designer card (always visible at bottom of pages, also shown here) -->
      <div class="designer-bar">
        <img class="designer-photo" src="https://s34.picofile.com/file/8488183492/2.png" alt="Designer" />
        <div class="designer-meta">
          <div class="designer-name">Designer</div>
          <div class="designer-id">A.R. Yousefzadeh</div>
        </div>
      </div>

      <!-- Lesson chooser -->
      <div class="lesson-grid">
        <button class="lesson-btn pulse" data-lesson="1">Lesson 1 â€” Personality</button>
        <button class="lesson-btn pulse" data-lesson="2">Lesson 2 â€” Travel</button>
        <button class="lesson-btn pulse" data-lesson="3">Lesson 3 â€” Festivals & Ceremonies</button>
        <button class="lesson-btn pulse" data-lesson="4">Lesson 4 â€” Services</button>
        <button class="lesson-btn pulse" data-lesson="5">Lesson 5 â€” Media</button>
        <button class="lesson-btn pulse" data-lesson="6">Lesson 6 â€” Health & Injuries</button>
      </div>

      <!-- Exams -->
      <div class="exam-grid">
        <button class="exam-btn glow" data-exam="midterm-1-3">Midterm A â€” Lessons 1â€“3</button>
        <button class="exam-btn glow" data-exam="midterm-1-3b">Midterm B â€” Lessons 1â€“3</button>
        <button class="exam-btn glow" data-exam="final-4-6">Final A â€” Lessons 4â€“6</button>
        <button class="exam-btn glow" data-exam="final-4-6b">Final B â€” Lessons 4â€“6</button>
      </div>

      <!-- Irregular verbs -->
      <div class="verbs-bar">
        <button class="btn gradient-btn" id="irregularVerbsBtn">Irregular verbs (list + pronunciation + examples)</button>
      </div>
    </div>
  </section>

  <!-- Flipbook wrapper -->
  <main id="flipbookWrapper" class="hidden">
    <div class="flipbook-nav">
      <button class="btn nav-btn" id="prevPageBtn" aria-label="Previous page">â€¹</button>
      <div class="current-title" id="currentTitle"></div>
      <button class="btn nav-btn" id="nextPageBtn" aria-label="Next page">â€º</button>
    </div>

    <!-- Flipbook pages container -->
    <div class="flipbook" id="flipbook">
      <!-- Pages will be injected dynamically from data.js by app.js -->
    </div>

    <!-- Bottom designer bar (persistent across pages) -->
    <footer class="designer-footer">
      <div class="designer-bar">
        <img class="designer-photo" src="https://s34.picofile.com/file/8488183492/2.png" alt="Designer" />
        <div class="designer-meta">
          <div class="designer-name">Designer</div>
          <div class="designer-id">A.R. Yousefzadeh</div>
        </div>
      </div>
    </footer>
  </main>

  <!-- Help modal -->
  <div class="modal hidden" id="helpModal" aria-hidden="true" role="dialog">
    <div class="modal-content">
      <h2>Ø±Ø§Ù‡Ù†Ù…Ø§ (Help)</h2>
      <div class="modal-cols">
        <div>
          <h3>ÙØ§Ø±Ø³ÛŒ</h3>
          <ul class="help-list">
            <li><b>Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø±Ø³:</b> Ø§Ø² ØµÙØ­Ù‡â€ŒÛŒ Ø¢ØºØ§Ø² Ø¯Ø±Ø³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</li>
            <li><b>ÙˆØ±Ù‚â€ŒØ²Ù†:</b> Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ â€¹ Ùˆ â€º Ø¨ÛŒÙ† ØµÙØ­Ø§Øª Ø­Ø±Ú©Øª Ú©Ù†ÛŒØ¯. Ø±ÙˆÛŒ Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ù…Ø¹Ù†ÛŒØŒ ØªÙ„ÙØ¸ØŒ Ù…ØªØ±Ø§Ø¯Ùâ€ŒÙ‡Ø§ Ùˆ Ø¬Ù…Ù„Ù‡â€ŒÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯.</li>
            <li><b>ØªÙ…Ø±ÛŒÙ†Ø§Øª:</b> Ù¾Ø§Ø³Ø® Ø±Ø§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯. Ø³Ù¾Ø³ Ø±ÙˆÛŒ Â«Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®Â» Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</li>
            <li><b>Ú¯Ø±Ø§Ù…Ø±:</b> Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ú¯Ø±Ø§Ù…Ø±ØŒ ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯.</li>
            <li><b>Ø¹Ú©Ø³â€ŒÙ†Ø§Ù…Ù‡ (Photo Dictionary):</b> ØªÙ„ÙØ¸ Ùˆ Ù…Ø¹Ù†ÛŒ ÙØ§Ø±Ø³ÛŒ Ù‡Ø± Ø¹Ø¨Ø§Ø±Øª Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯ Ùˆ Ù…Ø«Ø§Ù„ Ø³Ø§Ø¯Ù‡ Ú¯ÙˆØ´ Ú©Ù†ÛŒØ¯.</li>
            <li><b>Ø§ÙØ¹Ø§Ù„ Ø¨ÛŒâ€ŒÙ‚Ø§Ø¹Ø¯Ù‡:</b> Ù„ÛŒØ³Øª Ø²ÛŒØ¨Ø§ Ø¨Ø§ ØªÙ„ÙØ¸ Ùˆ Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§.</li>
          </ul>
        </div>
        <div>
          <h3>English</h3>
          <ul class="help-list">
            <li><b>Select lessons:</b> Choose a lesson on the start screen.</li>
            <li><b>Flipbook:</b> Use â€¹ and â€º to navigate. Click any word to see Persian meaning, synonyms, related words, sample sentence, and pronunciation.</li>
            <li><b>Workbook:</b> Type or choose answers; then click â€œShow answerâ€.</li>
            <li><b>Grammar:</b> Tap the grammar button to read explanations.</li>
            <li><b>Photo Dictionary:</b> Hear pronunciation, see Persian meanings and examples.</li>
            <li><b>Irregular Verbs:</b> Browse a styled list with TTS and examples.</li>
          </ul>
        </div>
      </div>
      <button class="btn outline-btn" id="closeHelpBtn">Close</button>
    </div>
  </div>

  <!-- Word info popup -->
  <div class="popup hidden" id="wordPopup" role="dialog" aria-hidden="true">
    <div class="popup-content">
      <div class="popup-header">
        <span id="popupWord"></span>
        <div class="popup-actions">
          <button class="btn small" id="pronounceBtn">ğŸ”Š Pronounce</button>
          <button class="btn small" id="closePopupBtn">âœ•</button>
        </div>
      </div>
      <div class="popup-body" id="popupBody">
        <!-- Filled by app.js using dictionary data -->
      </div>
    </div>
  </div>

  <!-- Exam modal -->
  <div class="modal hidden" id="examModal" aria-hidden="true" role="dialog">
    <div class="modal-content exam-content">
      <div class="exam-header">
        <h2 id="examTitle"></h2>
        <button class="btn outline-btn" id="closeExamBtn">Close</button>
      </div>
      <div class="exam-body" id="examBody"></div>
      <div class="exam-footer">
        <button class="btn glow-btn" id="submitExamBtn">Submit</button>
        <button class="btn outline-btn" id="showExamAnswersBtn">Show answers</button>
      </div>
    </div>
  </div>

  <!-- Irregular verbs modal -->
  <div class="modal hidden" id="verbsModal" aria-hidden="true" role="dialog">
    <div class="modal-content verbs-content">
      <div class="verbs-header">
        <h2>Irregular verbs</h2>
        <button class="btn outline-btn" id="closeVerbsBtn">Close</button>
      </div>
      <div class="verbs-body" id="verbsBody">
        <!-- Filled by data.js and app.js -->
      </div>
    </div>
  </div>

  <script src="data.js"></script>
  <script src="app.js"></script>
</body>
</html>
:root{
  --bg:#0b1220;
  --card:#121a2d;
  --accent:#71d7ff;
  --accent2:#13d38b;
  --text:#e9f1ff;
  --muted:#9bb3cc;
  --glow:0 0 12px rgba(19,211,139,.6), 0 0 24px rgba(19,211,139,.3);
  --pulse:0 0 0 rgba(113,215,255,0.7);
}

*{box-sizing:border-box}
html,body{margin:0;padding:0;background:linear-gradient(120deg,#0b1220,#14203a);color:var(--text);font-family:Inter,system-ui,Segoe UI,Arial}
button{cursor:pointer}

.topbar{
  position:sticky;top:0;z-index:10;height:60px;background:#0b1220cc;
  backdrop-filter: blur(6px);
  display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid #203055;
}

.brand-title{font-weight:700;letter-spacing:.4px}
.left-controls,.right-controls{display:flex;gap:8px}

.btn{
  border:none;padding:10px 14px;border-radius:10px;color:#fff;
  background:#1c2745;transition:transform .15s, box-shadow .15s, background .2s;
}
.btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.25)}
.outline-btn{background:transparent;border:1px solid #2f4577}
.glow-btn{background:linear-gradient(90deg,#13d38b,#71d7ff);color:#06233a;font-weight:700;box-shadow:var(--glow)}
.gradient-btn{background:linear-gradient(120deg,#1d6bff,#13d38b);color:#021427;font-weight:700}
.small{padding:6px 10px;border-radius:8px}

.start-screen{
  min-height:calc(100vh - 60px);
  display:flex;align-items:center;justify-content:center;padding:24px;
}
.start-card{
  width:min(1000px,95vw);
  background:linear-gradient(160deg,#10192f 0%, #0d1630 50%, #0b1429 100%);
  border:1px solid #23365f;
  box-shadow:0 20px 50px rgba(0,0,0,.35);
  border-radius:18px;
  padding:28px;
}
.title{font-size:2.2rem;margin:0 0 8px}
.subtitle{color:var(--muted);margin:0 0 16px}

.designer-bar{
  display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;
  background:linear-gradient(90deg,rgba(19,211,139,.10),rgba(113,215,255,.08));
  border:1px solid #2a455f;box-shadow:0 0 16px rgba(19,211,139,.15);
}
.designer-photo{width:64px;height:64px;border-radius:12px;object-fit:cover;border:1px solid #2a455f}
.designer-meta .designer-name{font-size:.9rem;color:#9bd6ff}
.designer-meta .designer-id{font-size:.85rem;color:#bde8ff}

.lesson-grid,.exam-grid,.verbs-bar{margin-top:18px;display:grid;gap:12px}
.lesson-grid{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
.exam-grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.lesson-btn,.exam-btn{
  border:none;padding:16px;border-radius:16px;font-weight:700;letter-spacing:.3px;
  background:linear-gradient(120deg,#1f3663,#16274b);color:#dff3ff;border:1px solid #2f4577;
  transition:transform .15s, box-shadow .15s, background .2s;
}
.lesson-btn:hover,.exam-btn:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.35)}
.pulse{animation:pulse 2.5s infinite}
.glow{box-shadow:0 0 16px rgba(113,215,255,.25),0 0 32px rgba(19,211,139,.15)}

@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(113,215,255,.7)}
  70%{box-shadow:0 0 0 20px rgba(113,215,255,0)}
  100%{box-shadow:0 0 0 0 rgba(113,215,255,0)}
}

.hidden{display:none}

.flipbook-wrapper{padding:16px}
.flipbook-nav{display:flex;align-items:center;justify-content:space-between;padding:10px 4px}
.nav-btn{font-size:20px;width:44px;height:44px;border-radius:12px}

.current-title{font-weight:700;color:#cfe7ff}

.flipbook{
  perspective:1500px;position:relative;
  width:min(1100px,96vw);margin:0 auto;
}
.page{
  background:linear-gradient(180deg,#111b32,#0d162c);
  border:1px solid #2d426b;border-radius:14px;
  width:100%;min-height:68vh;margin:18px 0;padding:18px;
  box-shadow:0 30px 60px rgba(0,0,0,.35);
  transform-origin:left center;transition:transform .7s ease, box-shadow .4s ease;
}
.page h2{margin-top:0}
.page-turn-enter{transform:rotateY(-180deg);box-shadow:0 20px 40px rgba(19,211,139,.25)}
.page-turn-leave{transform:rotateY(180deg);opacity:.0}

.section{margin:12px 0 20px;padding:12px;border:1px dashed #2f4577;border-radius:12px}
.section h3{margin:0 0 8px;color:#9bd6ff}
.section .text{line-height:1.75;color:#e4f0ff}

.word{cursor:pointer;border-bottom:1px dashed #2f4577}
.word:hover{color:#71d7ff}

.exercise-block{margin-top:12px}
.exercise-item{padding:8px;border-radius:10px;background:#0f1a32;border:1px solid #2a4068;margin-bottom:8px}
.exercise-controls{display:flex;gap:10px;margin-top:8px}
.answer-key{display:none;margin-top:6px;color:#bde8ff}
.answer-key.show{display:block}
.correct{outline:2px solid #13d38b}
.incorrect{outline:2px solid #ff6e6e}

.photo-dict-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:10px
}
.phrase-card{
  background:#0f1a32;border:1px solid #2a4068;border-radius:12px;padding:12px
}
.phrase-actions{display:flex;gap:8px;margin-top:8px}

.designer-footer{margin-top:24px}
.modal{
  position:fixed;inset:0;background:rgba(6,12,24,.6);
  display:flex;align-items:center;justify-content:center;padding:14px;z-index:100;
}
.modal-content{
  width:min(900px,96vw);
  background:linear-gradient(160deg,#10192f,#0d1630);
  border:1px solid #20355f;border-radius:18px;padding:16px;
  box-shadow:0 20px 50px rgba(0,0,0,.35);
}
.modal-cols{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.help-list{margin:8px 0 0 0;padding-left:18px}
.help-list li{margin:6px 0}

.popup{
  position:fixed;bottom:24px;right:24px;z-index:101;
}
.popup-content{
  width:min(420px,92vw);background:#0f1a32;border:1px solid #2a4068;border-radius:14px;
  box-shadow:0 12px 36px rgba(0,0,0,.35);
}
.popup-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px;border-bottom:1px solid #233a60
}
#popupWord{font-weight:800;color:#9bd6ff}
.popup-body{padding:10px}
.popup-body .row{margin:6px 0}
.popup-body .label{color:#9bb3cc;font-size:.9rem}
.popup-body .value{color:#eaf4ff}

.exam-content .exam-body{margin-top:10px}
.exam-question{padding:10px;border:1px solid #2a4068;border-radius:12px;background:#0f1a32;margin-bottom:10px}
.exam-question h4{margin:0 0 6px}
.verbs-content .verbs-body{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
.verb-card{background:#0f1a32;border:1px solid #2a4068;border-radius:12px;padding:10px}
.verb-head{display:flex;align-items:center;justify-content:space-between}
.verb-head .forms{font-weight:700;color:#9bd6ff}
.verb-ex{margin-top:6px;color:#eaf4ff}
/* data.js
   Structured lesson content extracted from SB9/WB9 and Answer key.
   Texts are normalized; where exercises need answers, keys added (from workbook answers).
   Photo dictionary items are grouped inside each lesson.
*/

window.LESSONS = [
  {
    id: 1,
    title: "Lesson 1 â€” Personality",
    sections: [
      {
        type: "conversation",
        title: "Conversation",
        text: `
Ehsan: Who is your best friend at school?
Parham: Reza.
Ehsan: What's he like?
Parham: Oh, he is really great! He's clever and kind.
Ehsan: Is he hard-working too?
Parham: Yes! And he's always very helpful.
Ehsan: How?
Parham: He always helps me with my lessons.
        `
      },
      {
        type: "practice",
        title: "Practice 1 â€” Talking about personality (1)",
        items: [
          { q: "Are you hard-working?", a: "Yes, I am." },
          { q: "Is he clever?", a: "Yes, he is." },
          { q: "Is Zahra talkative?", a: "No, she isn't." },
          { q: "Are they neat?", a: "Yes, they are." },
          { q: "Are they upset?", a: "No, they're not." }
        ]
      },
      {
        type: "practice",
        title: "Practice 2 â€” Talking about personality (2)",
        items: [
          { q: "What's your friend like?", a: "He's very funny." },
          { q: "What's your mother like?", a: "She's very kind and patient." },
          { q: "What's he like?", a: "He is quiet." },
          { q: "What's she like?", a: "She is clever." },
          { q: "What are you like?", a: "I'm a bit serious." },
          { q: "What are they like?", a: "They are very kind." }
        ]
      },
      {
        type: "languageMelody",
        title: "Language Melody â€” Affirmative",
        lines: [
          "Farzaneh is a clever student. Everybody likes her.",
          "Yes. I know. She is also very helpful.",
          "Well, you can ask her for help.",
          "Ok, I'll ask her to help me with my English."
        ],
        practice: [
          "He's very kind.",
          "She's very patient.",
          "You are very clever.",
          "Everybody likes her.",
          "I do my homework.",
          "She works for a company."
        ]
      },
      {
        type: "grammar",
        title: "Grammar â€” To be, Questions, There is/are",
        blocks: [
          {
            label: "Affirmative (to be)",
            text: "I am happy. He/She is happy. We/You/They are happy."
          },
          {
            label: "Questions (to be)",
            text: "Am I ... ? Is he/she ... ? Are we/you/they ... ?"
          },
          {
            label: "There is/are",
            text: "There is an eraser in the classroom. There are many students."
          },
          {
            label: "Negative (to be)",
            text: "I'm not talkative. He's not shy (He isn't shy). They're not rude (They aren't rude)."
          }
        ]
      },
      {
        type: "findIt",
        title: "Find it â€” underline 'to be' verbs",
        text: "I'm Mohsen. This is my classroom. There are 25 students in my class. I have a lot of friends. My best friend is Vahid. He's a good student. He is helpful and hard-working, but he is not very careful. He usually forgets important things. It's a big problem."
      },
      {
        type: "listening",
        title: "Listening, Reading and Writing (A)",
        items: [
          { q: "Listen and fill: Name", a: "" },
          { q: "Listen and fill: Personality", a: "" }
        ]
      },
      {
        type: "workbook",
        title: "Workbook â€” Lesson 1",
        items: [
          { type: "choice", q: "Kate isn't/aren't funny.", correct: "isn't" },
          { type: "choice", q: "There is/are a car in the street.", correct: "is" },
          { type: "choice", q: "There is/are fifteen benches in the class.", correct: "are" },
          { type: "choice", q: "It is/are really beautiful.", correct: "is" },
          { type: "choice", q: "Iranians is/are very brave.", correct: "are" },
          { type: "fill", q: "Fill (to be): I __ 14 years old. My school __ beautiful. There __ 30 students.", key: "am; is; are" },
          { type: "unscramble", q: "am/I/nervous/not/", key: "I am not nervous." },
          { type: "unscramble", q: "and/you/your friend/selfish/not/are/", key: "You and your friend are not selfish." },
          { type: "unscramble", q: "Mina/is/careless/?", key: "Is Mina careless?" }
        ]
      },
      {
        type: "photoDict",
        title: "Photo Dictionary â€” Personality",
        phrases: [
          { en: "an angry kid", fa: "ÛŒÚ© Ø¨Ú†Ù‡ Ø¹ØµØ¨Ø§Ù†ÛŒ", ex: "The angry kid shouted loudly.", tts: true },
          { en: "a brave soldier", fa: "ÛŒÚ© Ø³Ø±Ø¨Ø§Ø² Ø´Ø¬Ø§Ø¹", ex: "The brave soldier helped people.", tts: true },
          { en: "a careless man", fa: "ÛŒÚ© Ù…Ø±Ø¯ Ø¨ÛŒâ€ŒØ¯Ù‚Øª", ex: "The careless man lost his keys.", tts: true },
          { en: "a cruel boy", fa: "ÛŒÚ© Ù¾Ø³Ø± Ø¸Ø§Ù„Ù…", ex: "A cruel boy never shares toys.", tts: true },
          { en: "a funny story", fa: "ÛŒÚ© Ø¯Ø§Ø³ØªØ§Ù† Ø®Ù†Ø¯Ù‡â€ŒØ¯Ø§Ø±", ex: "It is a funny story.", tts: true },
          { en: "a neat person", fa: "ÛŒÚ© ÙØ±Ø¯ Ù…Ø±ØªØ¨", ex: "He is a neat person.", tts: true },
          { en: "a nervous boy", fa: "ÛŒÚ© Ù¾Ø³Ø± Ø¹ØµØ¨ÛŒ", ex: "The nervous boy is shy.", tts: true },
          { en: "a quiet place", fa: "ÛŒÚ© Ù…Ú©Ø§Ù† Ø³Ø§Ú©Øª", ex: "This is a quiet place.", tts: true },
          { en: "a rude kid", fa: "ÛŒÚ© Ø¨Ú†Ù‡ Ø¨ÛŒâ€ŒØ§Ø¯Ø¨", ex: "A rude kid doesn't listen.", tts: true },
          { en: "a selfish person", fa: "ÛŒÚ© ÙØ±Ø¯ Ø®ÙˆØ¯Ø®ÙˆØ§Ù‡", ex: "A selfish person thinks only about himself.", tts: true },
          { en: "a hard-working worker", fa: "ÛŒÚ© Ú©Ø§Ø±Ú¯Ø± Ø³Ø®Øªâ€ŒÚ©ÙˆØ´", ex: "He is a hard-working worker.", tts: true },
          { en: "a lazy person", fa: "ÛŒÚ© ÙØ±Ø¯ ØªÙ†Ø¨Ù„", ex: "A lazy person doesn't like to work.", tts: true },
          { en: "a shy girl", fa: "ÛŒÚ© Ø¯Ø®ØªØ± Ø®Ø¬Ø§Ù„ØªÛŒ", ex: "The shy girl speaks quietly.", tts: true },
          { en: "a generous girl", fa: "ÛŒÚ© Ø¯Ø®ØªØ± Ø³Ø®Ø§ÙˆØªÙ…Ù†Ø¯", ex: "A generous girl helps others.", tts: true }
        ]
      }
    ]
  },

  /* Lessons 2â€“6 omitted here for brevity in this snippet,
     but in your actual data.js you will include all extracted content
     similarly structured:
     - Conversation
     - Practice (1,2)
     - Language Melody
     - Grammar
     - Find it
     - Listening A/B
     - Workbook items (with keys from 'work book Answer .pdf')
     - Photo Dictionary (per lesson group)
  */

];


// Exams
window.EXAMS = {
  "midterm-1-3": {
    title: "Midterm Exam A â€” Lessons 1â€“3",
    questions: [
      { type: "mc", q: "Choose the correct 'to be' form: They __ kind.", opts: ["is","are","am"], key: "are" },
      { type: "short", q: "Write a question with 'What's he like?' and answer briefly." },
      { type: "mc", q: "Present Simple: She __ lunch at noon.", opts: ["cook","cooks","is cooking"], key: "cooks" },
      { type: "match", q: "Match personality words", pairs: [["brave","Ø´Ø¬Ø§Ø¹"],["neat","Ù…Ø±ØªØ¨"],["rude","Ø¨ÛŒâ€ŒØ§Ø¯Ø¨"],["careless","Ø¨ÛŒâ€ŒØ¯Ù‚Øª"]] },
      { type: "fill", q: "There __ many tourists in this city. (is/are)", key: "are" },
      { type: "short", q: "Write a sentence using 'There is/There are' (Festivals or Travel topic)." },
      { type: "mc", q: "Do/Does: __ you visit your relatives on holidays?", opts: ["Do","Does"], key: "Do" },
      { type: "mc", q: "Which has rising intonation? (choose)", opts: ["Affirmative sentence","Yes/No question"], key: "Yes/No question" },
      { type: "short", q: "Write two personality adjectives and describe a classmate." },
      { type: "mc", q: "Choose: We __ to a museum. (often/never/rarely)", opts: ["often","never","rarely"], key: "often" }
    ]
  },
  "midterm-1-3b": {
    title: "Midterm Exam B â€” Lessons 1â€“3",
    questions: [
      { type: "mc", q: "Choose: Is/Are: __ they helpful?", opts: ["Is","Are"], key: "Are" },
      { type: "short", q: "Write a 'Find it' sentence and underline 'to be' verbs." },
      { type: "mc", q: "Present Simple: They __ stories at night.", opts: ["tell","tells","are telling"], key: "tell" },
      { type: "fill", q: "Complete: What's your friend like? â€” He __ funny.", key: "is" },
      { type: "mc", q: "Choose: Do/Does __ she get gifts on Norooz?", opts: ["Do","Does"], key: "Does" },
      { type: "short", q: "Write a sentence about a festival activity (use 'we')." },
      { type: "mc", q: "Choose: Affirmative intonation goes (falling/rising).", opts: ["falling","rising"], key: "falling" },
      { type: "match", q: "Match travel verbs", pairs: [["check in","ØªØ­ÙˆÛŒÙ„ Ø§ØªØ§Ù‚"],["take off","Ø¨Ø±Ø®Ø§Ø³ØªÙ†"],["land","ÙØ±ÙˆØ¯ Ø¢Ù…Ø¯Ù†"],["exchange money","ØªØ¹ÙˆÛŒØ¶ Ù¾ÙˆÙ„"]] },
      { type: "fill", q: "There __ a computer in the classroom. (is/are)", key: "is" },
      { type: "short", q: "Write two 'Do/Does' questions about travel." }
    ]
  },
  "final-4-6": {
    title: "Final Exam A â€” Lessons 4â€“6",
    questions: [
      { type: "mc", q: "WH question: __ do you live?", opts: ["Where","What","Who"], key: "Where" },
      { type: "mc", q: "Adverb of frequency: She __ studies hard.", opts: ["never","always","rarely"], key: "always" },
      { type: "mc", q: "Past Simple: He __ a message yesterday.", opts: ["send","sends","sent"], key: "sent" },
      { type: "fill", q: "Complete: He __ his leg last week. (broke / break)", key: "broke" },
      { type: "match", q: "Match services", pairs: [["put out fire","Ø¢ØªØ´ Ø±Ø§ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù†"],["hire a taxi","Ú¯Ø±ÙØªÙ† ØªØ§Ú©Ø³ÛŒ"],["open an account","Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø­Ø³Ø§Ø¨"],["call 115","ØªÙ…Ø§Ø³ Ø¨Ø§ Ø§ÙˆØ±Ú˜Ø§Ù†Ø³"]] },
      { type: "short", q: "Write 2 sentences with 'was/were' (media or services)." },
      { type: "mc", q: "Choose: Past of 'go' is __.", opts: ["went","goed","gone"], key: "went" },
      { type: "short", q: "Write an injury report sentence with 'hurt'." },
      { type: "mc", q: "Choose: Past of 'take off' is __.", opts: ["taked off","took off","taken off"], key: "took off" },
      { type: "short", q: "Write a WH question about a service in your city." }
    ]
  },
  "final-4-6b": {
    title: "Final Exam B â€” Lessons 4â€“6",
    questions: [
      { type: "mc", q: "WH question: __ does the bank open?", opts: ["Where","When","Why"], key: "When" },
      { type: "mc", q: "Past of 'see' is __.", opts: ["saw","seed","seen"], key: "saw" },
      { type: "fill", q: "Complete: They __ on TV last night. (watched / watch)", key: "watched" },
      { type: "short", q: "Write 2 sentences using 'always/never' about services." },
      { type: "mc", q: "Choose: Past of 'break' is __.", opts: ["breaked","broke","broken"], key: "broke" },
      { type: "match", q: "Match health phrases", pairs: [["It is bleeding","Ø®ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ Ø¯Ø§Ø±Ø¯"],["Stick a plaster","Ú†Ø³Ø¨ Ø²Ø®Ù… Ø¨Ø²Ù†"],["He hit his head","Ø³Ø±Ø´ Ø±Ø§ Ø²Ø¯"],["She cut her finger","Ø§Ù†Ú¯Ø´ØªØ´ Ø±Ø§ Ø¨Ø±ÛŒØ¯"]] },
      { type: "short", q: "Write a 'Do/Does' question and answer (media)." },
      { type: "mc", q: "Choose: Past of 'write' is __.", opts: ["writed","wrote","written"], key: "wrote" },
      { type: "fill", q: "Complete: He __ in the ER. (works / worked) â€” choose one and justify.", key: "works" },
      { type: "short", q: "Write a WH question about an accident." }
    ]
  }
};

// Minimal dictionary (extend anytime).
window.DICT = {
  "clever": { fa: "Ø¨Ø§Ù‡ÙˆØ´", syn: ["smart","bright","intelligent"], rel: ["wise","brainy"], ex: "He is a clever student." },
  "kind": { fa: "Ù…Ù‡Ø±Ø¨Ø§Ù†", syn: ["nice","friendly","helpful"], rel: ["polite","gentle"], ex: "She is kind to everyone." },
  "hard-working": { fa: "Ù¾Ø±ØªÙ„Ø§Ø´", syn: ["diligent","industrious"], rel: ["active","busy"], ex: "They are hard-working people." },
  "helpful": { fa: "Ú©Ù…Ú©â€ŒÚ©Ù†Ù†Ø¯Ù‡", syn: ["supportive","useful"], rel: ["kind","friendly"], ex: "He is helpful in class." },
  "funny": { fa: "Ø®Ù†Ø¯Ù‡â€ŒØ¯Ø§Ø±", syn: ["humorous","amusing"], rel: ["happy","jolly"], ex: "It is a funny story." },
  "quiet": { fa: "Ø¢Ø±Ø§Ù…", syn: ["silent","calm"], rel: ["peaceful","still"], ex: "This is a quiet place." },
  // Add more as neededâ€¦
};

// Irregular verbs list with examples
window.IRREGULAR_VERBS = [
  { base: "be", past: "was/were", exEn: "I was happy yesterday.", exFa: "Ù…Ù† Ø¯ÛŒØ±ÙˆØ² Ø®ÙˆØ´Ø­Ø§Ù„ Ø¨ÙˆØ¯Ù…." },
  { base: "become", past: "became", exEn: "She became a doctor.", exFa: "Ø§Ùˆ Ø¯Ú©ØªØ± Ø´Ø¯." },
  { base: "bleed", past: "bled", exEn: "It bled a lot.", exFa: "Ø®ÛŒÙ„ÛŒ Ø®ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ Ú©Ø±Ø¯." },
  { base: "break", past: "broke", exEn: "He broke his leg.", exFa: "Ø§Ùˆ Ù¾Ø§ÛŒØ´ Ø±Ø§ Ø´Ú©Ø³Øª." },
  { base: "bring", past: "brought", exEn: "They brought food.", exFa: "Ø¢Ù†â€ŒÙ‡Ø§ ØºØ°Ø§ Ø¢ÙˆØ±Ø¯Ù†Ø¯." },
  { base: "build", past: "built", exEn: "We built a bridge.", exFa: "Ù…Ø§ ÛŒÚ© Ù¾Ù„ Ø³Ø§Ø®ØªÛŒÙ…." },
  { base: "buy", past: "bought", exEn: "She bought a ticket.", exFa: "Ø§Ùˆ Ø¨Ù„ÛŒØ· Ø®Ø±ÛŒØ¯." },
  { base: "choose", past: "chose", exEn: "He chose the movie.", exFa: "Ø§Ùˆ ÙÛŒÙ„Ù… Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯." },
  { base: "come", past: "came", exEn: "They came late.", exFa: "Ø¢Ù†â€ŒÙ‡Ø§ Ø¯ÛŒØ± Ø¢Ù…Ø¯Ù†Ø¯." },
  { base: "cut", past: "cut", exEn: "I cut my finger.", exFa: "Ù…Ù† Ø§Ù†Ú¯Ø´ØªÙ… Ø±Ø§ Ø¨Ø±ÛŒØ¯Ù…." },
  { base: "do", past: "did", exEn: "We did our homework.", exFa: "Ù…Ø§ ØªÚ©Ù„ÛŒÙâ€ŒÙ…Ø§Ù† Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯ÛŒÙ…." },
  { base: "drink", past: "drank", exEn: "He drank water.", exFa: "Ø§Ùˆ Ø¢Ø¨ Ù†ÙˆØ´ÛŒØ¯." },
  { base: "drive", past: "drove", exEn: "She drove to Tehran.", exFa: "Ø§Ùˆ Ø¨Ù‡ ØªÙ‡Ø±Ø§Ù† Ø±Ø§Ù†Ù†Ø¯Ú¯ÛŒ Ú©Ø±Ø¯." },
  { base: "eat", past: "ate", exEn: "They ate lunch.", exFa: "Ø¢Ù†â€ŒÙ‡Ø§ Ù†Ø§Ù‡Ø§Ø± Ø®ÙˆØ±Ø¯Ù†Ø¯." },
  { base: "fall", past: "fell", exEn: "He fell down.", exFa: "Ø§Ùˆ Ø§ÙØªØ§Ø¯." },
  { base: "feel", past: "felt", exEn: "I felt tired.", exFa: "Ù…Ù† Ø§Ø­Ø³Ø§Ø³ Ø®Ø³ØªÚ¯ÛŒ Ú©Ø±Ø¯Ù…." },
  { base: "find", past: "found", exEn: "We found the shop.", exFa: "Ù…Ø§ Ù…ØºØ§Ø²Ù‡ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯ÛŒÙ…." },
  { base: "forget", past: "forgot", exEn: "She forgot the keys.", exFa: "Ø§Ùˆ Ú©Ù„ÛŒØ¯Ù‡Ø§ Ø±Ø§ ÙØ±Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯." },
  { base: "get", past: "got", exEn: "I got a message.", exFa: "Ù…Ù† ÛŒÚ© Ù¾ÛŒØ§Ù… Ú¯Ø±ÙØªÙ…." },
  { base: "give", past: "gave", exEn: "He gave me his book.", exFa: "Ø§Ùˆ Ú©ØªØ§Ø¨Ø´ Ø±Ø§ Ø¨Ù‡ Ù…Ù† Ø¯Ø§Ø¯." },
  { base: "go", past: "went", exEn: "They went home.", exFa: "Ø¢Ù†â€ŒÙ‡Ø§ Ø¨Ù‡ Ø®Ø§Ù†Ù‡ Ø±ÙØªÙ†Ø¯." },
  { base: "have", past: "had", exEn: "We had fun.", exFa: "Ù…Ø§ Ø®ÙˆØ´ Ú¯Ø°Ø±Ø§Ù†Ø¯ÛŒÙ…." },
  { base: "hear", past: "heard", exEn: "I heard the news.", exFa: "Ù…Ù† Ø®Ø¨Ø± Ø±Ø§ Ø´Ù†ÛŒØ¯Ù…." },
  { base: "hit", past: "hit", exEn: "He hit his head.", exFa: "Ø§Ùˆ Ø³Ø±Ø´ Ø±Ø§ Ø²Ø¯." },
  { base: "hurt", past: "hurt", exEn: "She hurt her knee.", exFa: "Ø§Ùˆ Ø²Ø§Ù†ÙˆÛŒØ´ Ø±Ø§ Ø¢Ø³ÛŒØ¨ Ø²Ø¯." },
  { base: "keep", past: "kept", exEn: "We kept the ticket.", exFa: "Ù…Ø§ Ø¨Ù„ÛŒØ· Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÛŒÙ…." },
  { base: "know", past: "knew", exEn: "He knew the answer.", exFa: "Ø§Ùˆ Ù¾Ø§Ø³Ø® Ø±Ø§ Ù…ÛŒâ€ŒØ¯Ø§Ù†Ø³Øª." },
  { base: "leave", past: "left", exEn: "She left early.", exFa: "Ø§Ùˆ Ø²ÙˆØ¯ Ø±ÙØª." },
  { base: "lose", past: "lost", exEn: "They lost the match.", exFa: "Ø¢Ù†â€ŒÙ‡Ø§ Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø±Ø§ Ø¨Ø§Ø®ØªÙ†Ø¯." },
  { base: "make", past: "made", exEn: "He made lunch.", exFa: "Ø§Ùˆ Ù†Ø§Ù‡Ø§Ø± Ø¯Ø±Ø³Øª Ú©Ø±Ø¯." },
  { base: "meet", past: "met", exEn: "I met my friend.", exFa: "Ù…Ù† Ø¯ÙˆØ³ØªÙ… Ø±Ø§ Ø¯ÛŒØ¯Ù…." },
  { base: "pay", past: "paid", exEn: "She paid the bill.", exFa: "Ø§Ùˆ ØµÙˆØ±ØªØ­Ø³Ø§Ø¨ Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯." },
  { base: "put", past: "put", exEn: "He put it on the table.", exFa: "Ø§Ùˆ Ø¢Ù† Ø±Ø§ Ø±ÙˆÛŒ Ù…ÛŒØ² Ú¯Ø°Ø§Ø´Øª." },
  { base: "read", past: "read (/red)", exEn: "I read a book.", exFa: "Ù…Ù† Ú©ØªØ§Ø¨ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù…." },
  { base: "ride", past: "rode", exEn: "She rode a bike.", exFa: "Ø§Ùˆ Ø¯ÙˆÚ†Ø±Ø®Ù‡â€ŒØ³ÙˆØ§Ø±ÛŒ Ú©Ø±Ø¯." },
  { base: "run", past: "ran", exEn: "They ran fast.", exFa: "Ø¢Ù†â€ŒÙ‡Ø§ Ø³Ø±ÛŒØ¹ Ø¯ÙˆÛŒØ¯Ù†Ø¯." },
  { base: "say", past: "said", exEn: "He said hello.", exFa: "Ø§Ùˆ Ø³Ù„Ø§Ù… Ú¯ÙØª." },
  { base: "see", past: "saw", exEn: "We saw a movie.", exFa: "Ù…Ø§ ÙÛŒÙ„Ù…ÛŒ Ø¯ÛŒØ¯ÛŒÙ…." },
  { base: "set", past: "set", exEn: "They set the table.", exFa: "Ø¢Ù†â€ŒÙ‡Ø§ Ù…ÛŒØ² Ø±Ø§ Ú†ÛŒØ¯Ù†Ø¯." },
  { base: "sell", past: "sold", exEn: "He sold his car.", exFa: "Ø§Ùˆ Ù…Ø§Ø´ÛŒÙ†Ø´ Ø±Ø§ ÙØ±ÙˆØ®Øª." },
  { base: "send", past: "sent", exEn: "She sent an email.", exFa: "Ø§Ùˆ Ø§ÛŒÙ…ÛŒÙ„ÛŒ ÙØ±Ø³ØªØ§Ø¯." },
  { base: "sing", past: "sang", exEn: "He sang a song.", exFa: "Ø§Ùˆ ÛŒÚ© Ø¢Ù‡Ù†Ú¯ Ø®ÙˆØ§Ù†Ø¯." },
  { base: "sit", past: "sat", exEn: "We sat down.", exFa: "Ù…Ø§ Ù†Ø´Ø³ØªÛŒÙ…." },
  { base: "sleep", past: "slept", exEn: "They slept well.", exFa: "Ø¢Ù†â€ŒÙ‡Ø§ Ø®ÙˆØ¨ Ø®ÙˆØ§Ø¨ÛŒØ¯Ù†Ø¯." },
  { base: "speak", past: "spoke", exEn: "She spoke English.", exFa: "Ø§Ùˆ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ØµØ­Ø¨Øª Ú©Ø±Ø¯." },
  { base: "stand", past: "stood", exEn: "I stood up.", exFa: "Ù…Ù† Ø§ÛŒØ³ØªØ§Ø¯Ù…." },
  { base: "stick", past: "stuck", exEn: "He stuck a poster.", exFa: "Ø§Ùˆ ÛŒÚ© Ù¾ÙˆØ³ØªØ± Ú†Ø³Ø¨Ø§Ù†Ø¯." },
  { base: "swim", past: "swam", exEn: "They swam in the pool.", exFa: "Ø¢Ù†â€ŒÙ‡Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø± Ø´Ù†Ø§ Ú©Ø±Ø¯Ù†Ø¯." },
  { base: "take", past: "took", exEn: "He took a photo.", exFa: "Ø§Ùˆ ÛŒÚ© Ø¹Ú©Ø³ Ú¯Ø±ÙØª." },
  { base: "take off", past: "took off", exEn: "The plane took off.", exFa: "Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ Ø¨Ù„Ù†Ø¯ Ø´Ø¯." },
  { base: "teach", past: "taught", exEn: "She taught math.", exFa: "Ø§Ùˆ Ø±ÛŒØ§Ø¶ÛŒ ØªØ¯Ø±ÛŒØ³ Ú©Ø±Ø¯." },
  { base: "tell", past: "told", exEn: "He told a story.", exFa: "Ø§Ùˆ Ø¯Ø§Ø³ØªØ§Ù†ÛŒ Ú¯ÙØª." },
  { base: "think", past: "thought", exEn: "I thought about it.", exFa: "Ø¯Ø± Ù…ÙˆØ±Ø¯Ø´ ÙÚ©Ø± Ú©Ø±Ø¯Ù…." },
  { base: "understand", past: "understood", exEn: "We understood the lesson.", exFa: "Ù…Ø§ Ø¯Ø±Ø³ Ø±Ø§ ÙÙ‡Ù…ÛŒØ¯ÛŒÙ…." },
  { base: "wake", past: "woke", exEn: "He woke up early.", exFa: "Ø§Ùˆ Ø²ÙˆØ¯ Ø¨ÛŒØ¯Ø§Ø± Ø´Ø¯." },
  { base: "wear", past: "wore", exEn: "She wore a dress.", exFa: "Ø§Ùˆ Ù„Ø¨Ø§Ø³ Ù¾ÙˆØ´ÛŒØ¯." },
  { base: "write", past: "wrote", exEn: "They wrote a letter.", exFa: "Ø¢Ù†â€ŒÙ‡Ø§ Ù†Ø§Ù…Ù‡â€ŒØ§ÛŒ Ù†ÙˆØ´ØªÙ†Ø¯." }
];
/* app.js */

const startScreen = document.getElementById('startScreen');
const flipbookWrapper = document.getElementById('flipbookWrapper');
const flipbookEl = document.getElementById('flipbook');
const currentTitleEl = document.getElementById('currentTitle');
const prevPageBtn = document.getElementById('prevPageBtn');
const nextPageBtn = document.getElementById('nextPageBtn');
const helpBtn = document.getElementById('helpBtn');
const helpModal = document.getElementById('helpModal');
const closeHelpBtn = document.getElementById('closeHelpBtn');
const musicBtn = document.getElementById('musicBtn');
const bgMusic = document.getElementById('bgMusic');
const irregularVerbsBtn = document.getElementById('irregularVerbsBtn');
const verbsModal = document.getElementById('verbsModal');
const closeVerbsBtn = document.getElementById('closeVerbsBtn');
const verbsBody = document.getElementById('verbsBody');
const examModal = document.getElementById('examModal');
const examTitle = document.getElementById('examTitle');
const examBody = document.getElementById('examBody');
const closeExamBtn = document.getElementById('closeExamBtn');
const submitExamBtn = document.getElementById('submitExamBtn');
const showExamAnswersBtn = document.getElementById('showExamAnswersBtn');

const wordPopup = document.getElementById('wordPopup');
const popupWord = document.getElementById('popupWord');
const popupBody = document.getElementById('popupBody');
const closePopupBtn = document.getElementById('closePopupBtn');
const pronounceBtn = document.getElementById('pronounceBtn');

let currentLesson = null;
let pages = [];
let currentPageIndex = 0;
let currentExam = null;

// Sound click feedback (gentle)
const clickSound = new Audio();
clickSound.src = "";
// If you want a light UI click, add a file path, e.g. assets/sfx/click.mp3

// Start: lesson selection
document.querySelectorAll('.lesson-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    playClick();
    const lessonId = parseInt(btn.dataset.lesson,10);
    loadLesson(lessonId);
  });
});

// Exams
document.querySelectorAll('.exam-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    playClick();
    const examKey = btn.dataset.exam;
    openExam(examKey);
  });
});

// Music toggle
musicBtn.addEventListener('click', ()=>{
  playClick();
  if(bgMusic.paused){
    bgMusic.play().catch(()=>{});
    musicBtn.textContent = "â™« Music (Playing)";
  }else{
    bgMusic.pause();
    musicBtn.textContent = "â™« Music";
  }
});

// Help
helpBtn.addEventListener('click', ()=>{
  helpModal.classList.remove('hidden');
});
closeHelpBtn.addEventListener('click', ()=>{
  helpModal.classList.add('hidden');
});

// Verbs list
irregularVerbsBtn.addEventListener('click', ()=>{
  renderVerbs();
  verbsModal.classList.remove('hidden');
});
closeVerbsBtn.addEventListener('click', ()=>{
  verbsModal.classList.add('hidden');
});

// Exams modals
closeExamBtn.addEventListener('click', ()=>{
  examModal.classList.add('hidden');
  currentExam = null;
});
submitExamBtn.addEventListener('click', gradeExam);
showExamAnswersBtn.addEventListener('click', showExamAnswers);

// Navigation
prevPageBtn.addEventListener('click', ()=>turnPage(-1));
nextPageBtn.addEventListener('click', ()=>turnPage(1));

// Word popup
closePopupBtn.addEventListener('click', ()=>wordPopup.classList.add('hidden'));
pronounceBtn.addEventListener('click', ()=>pronounce(popupWord.textContent));

// Functions
function playClick(){
  if(clickSound.src) clickSound.currentTime=0, clickSound.play().catch(()=>{});
}

function loadLesson(id){
  const lesson = window.LESSONS.find(l=>l.id===id);
  if(!lesson){alert("Lesson not found.");return;}
  currentLesson = lesson;
  startScreen.classList.add('hidden');
  flipbookWrapper.classList.remove('hidden');
  currentTitleEl.textContent = lesson.title;
  pages = buildPages(lesson);
  currentPageIndex = 0;
  renderFlipbook();
}

function buildPages(lesson){
  const pgs = [];
  lesson.sections.forEach(sec=>{
    pgs.push(sectionToPage(sec, lesson));
  });
  // Add workbook photo dictionary or exam triggers if needed in dedicated pages
  return pgs;
}

function renderFlipbook(){
  flipbookEl.innerHTML = "";
  pages.forEach((page, idx)=>{
    const pageEl = document.createElement('div');
    pageEl.className = 'page';
    pageEl.dataset.index = idx;
    pageEl.innerHTML = page.html;
    flipbookEl.appendChild(pageEl);
  });
  bindPageEvents();
  highlightCurrentPage();
}

function bindPageEvents(){
  // word click
  flipbookEl.querySelectorAll('.word').forEach(w=>{
    w.addEventListener('click', ()=>{
      showWordInfo(w.textContent.trim().toLowerCase());
    });
  });
  // exercises buttons
  flipbookEl.querySelectorAll('.reveal-key').forEach(b=>{
    b.addEventListener('click', ()=>{
      const key = b.closest('.exercise-item').querySelector('.answer-key');
      key.classList.toggle('show');
    });
  });
  flipbookEl.querySelectorAll('.check-input').forEach(b=>{
    b.addEventListener('click', ()=>{
      const item = b.closest('.exercise-item');
      const input = item.querySelector('input, textarea, select');
      const key = (item.dataset.key||"").trim().toLowerCase();
      if(!input){return;}
      const val = (input.value||"").trim().toLowerCase();
      if(val===key || key.includes(val)){
        input.classList.add('correct'); input.classList.remove('incorrect');
      }else{
        input.classList.add('incorrect'); input.classList.remove('correct');
      }
    });
  });
}

function highlightCurrentPage(){
  flipbookEl.querySelectorAll('.page').forEach((p,idx)=>{
    p.classList.remove('page-turn-enter','page-turn-leave');
    if(idx===currentPageIndex) p.classList.add('page-turn-enter');
    else p.classList.add('page-turn-leave');
  });
}

function turnPage(dir){
  const next = currentPageIndex + dir;
  if(next<0 || next>=pages.length) return;
  currentPageIndex = next;
  highlightCurrentPage();
}

function sectionToPage(sec, lesson){
  const title = `<h2>${sec.title}</h2>`;
  let body = "";

  if(sec.type==="conversation" || sec.type==="findIt" || sec.type==="languageMelody"){
    body += `<div class="section"><h3>${sec.title}</h3><div class="text">${inlineWords(sec.text||"")}</div></div>`;
    if(sec.lines){
      body += `<div class="section"><h3>Conversation</h3><div class="text">${inlineWords(sec.lines.join("<br/>"))}</div></div>`;
    }
    if(sec.practice){
      body += `<div class="section"><h3>Practice</h3><div class="text">${inlineWords(sec.practice.join("<br/>"))}</div></div>`;
    }
  }

  if(sec.type==="practice"){
    body += `<div class="section"><h3>${sec.title}</h3>${sec.items.map(it=>`
      <div class="exercise-item" data-key="${(it.a||'').toLowerCase()}">
        <div><b>Q:</b> ${inlineWords(it.q)}</div>
        <div class="exercise-controls">
          <input type="text" placeholder="Type your answer"/>
          <button class="btn check-input">Check</button>
          <button class="btn outline-btn reveal-key">Show answer</button>
        </div>
        <div class="answer-key"><b>Answer:</b> ${it.a}</div>
      </div>
    `).join("")}</div>`;
  }

  if(sec.type==="grammar"){
    body += `<div class="section"><h3>${sec.title}</h3>
      ${sec.blocks.map(b=>`
        <div class="exercise-item">
          <div><b>${b.label}:</b> ${inlineWords(b.text)}</div>
          <div class="exercise-controls">
            <button class="btn outline-btn" onclick="alert('${escapeJs(b.text)}')">Show explanation</button>
          </div>
        </div>
      `).join("")}
    </div>`;
  }

  if(sec.type==="listening"){
    body += `<div class="section"><h3>${sec.title}</h3>
      <blockquote>Audio files will be added per your next upload. This section is ready to attach them.</blockquote>
      ${sec.items.map(it=>`
      <div class="exercise-item">
        <div><b>${inlineWords(it.q)}</b></div>
        <div class="exercise-controls">
          <input type="text" placeholder="Write your answer here"/>
          <button class="btn outline-btn reveal-key">Show answer</button>
        </div>
        <div class="answer-key"><b>Answer:</b> ${(it.a||'')}</div>
      </div>`).join("")}
    </div>`;
  }

  if(sec.type==="workbook"){
    body += `<div class="section"><h3>${sec.title}</h3>
      ${sec.items.map(it=>{
        if(it.type==="choice"){
          return `<div class="exercise-item" data-key="${(it.correct||'').toLowerCase()}">
            <div><b>${inlineWords(it.q)}</b></div>
            <div class="exercise-controls">
              <select>
                ${extractOptions(it.q).map(o=>`<option value="${o.toLowerCase()}">${o}</option>`).join("")}
              </select>
              <button class="btn check-input">Check</button>
              <button class="btn outline-btn reveal-key">Show answer</button>
            </div>
            <div class="answer-key"><b>Answer:</b> ${it.correct}</div>
          </div>`;
        }
        if(it.type==="fill"){
          return `<div class="exercise-item" data-key="${(it.key||'').toLowerCase()}">
            <div><b>${inlineWords(it.q)}</b></div>
            <div class="exercise-controls">
              <input type="text" placeholder="Use ; between parts (e.g., am; is; are)"/>
              <button class="btn check-input">Check</button>
              <button class="btn outline-btn reveal-key">Show answer</button>
            </div>
            <div class="answer-key"><b>Answer:</b> ${it.key}</div>
          </div>`;
        }
        if(it.type==="unscramble"){
          return `<div class="exercise-item" data-key="${(it.key||'').toLowerCase()}">
            <div><b>Unscramble:</b> ${inlineWords(it.q)}</div>
            <div class="exercise-controls">
              <input type="text" placeholder="Type the correct sentence"/>
              <button class="btn check-input">Check</button>
              <button class="btn outline-btn reveal-key">Show answer</button>
            </div>
            <div class="answer-key"><b>Answer:</b> ${it.key}</div>
          </div>`;
        }
        return "";
      }).join("")}
    </div>`;
  }

  if(sec.type==="photoDict"){
    body += `<div class="section"><h3>${sec.title}</h3>
      <div class="photo-dict-grid">
        ${sec.phrases.map(p=>`
          <div class="phrase-card">
            <div><b>${p.en}</b></div>
            <div class="muted">${p.fa}</div>
            <div class="phrase-actions">
              <button class="btn small" onclick="pronounce('${sanitizeTTS(p.en)}')">ğŸ”Š Pronounce</button>
              <button class="btn small" onclick="alert('Example: ${escapeJs(p.ex)}\\nÙ…Ø«Ø§Ù„: ${escapeJs(p.fa)}')">Example</button>
            </div>
          </div>
        `).join("")}
      </div>
    </div>`;
  }

  const html = `${title}${body}`;
  return { html };
}

function inlineWords(text){
  // Wrap likely words with .word to enable click dictionary (simple heuristic)
  return text.replace(/\b([A-Za-z][A-Za-z\-']+)\b/g,(m)=>`<span class="word">${m}</span>`);
}

function showWordInfo(word){
  const info = window.DICT[word];
  popupWord.textContent = word;
  popupBody.innerHTML = info ? `
    <div class="row"><span class="label">Persian:</span> <span class="value">${info.fa}</span></div>
    <div class="row"><span class="label">Synonyms:</span> <span class="value">${(info.syn||[]).join(", ")}</span></div>
    <div class="row"><span class="label">Related:</span> <span class="value">${(info.rel||[]).join(", ")}</span></div>
    <div class="row"><span class="label">Example:</span> <span class="value">${info.ex}</span></div>
    <div class="row"><span class="label">Meaning in a simple sentence (FA):</span> <span class="value">${simpleFa(info)}</span></div>
  ` : `
    <div class="row"><span class="label">No entry yet:</span> <span class="value">You can add a meaning for "${word}" to DICT in data.js.</span></div>
  `;
  wordPopup.classList.remove('hidden');
}

function simpleFa(info){
  if(!info) return "â€”";
  // crude mapping: use fa meaning in a simple sentence
  return `Ø§ÛŒÙ† Ú©Ù„Ù…Ù‡ ÛŒØ¹Ù†ÛŒ "${info.fa}".`;
}

function pronounce(text){
  if(!window.speechSynthesis){ alert("Speech Synthesis not supported in this browser."); return; }
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  window.speechSynthesis.speak(u);
}

function extractOptions(q){
  // find pattern X/Y or X / Y inside question string
  const parts = q.match(/([A-Za-z']+\s*\/\s*[A-Za-z']+)/g);
  if(parts){
    const [pair] = parts;
    return pair.split('/').map(s=>s.trim());
  }
  // fallback for workbook style "is/are" etc
  const slash = q.split('/');
  if(slash.length>1){
    // attempt to pick two around
    const last = slash[slash.length-1];
    // naive fallback
    return ["is","are","am"];
  }
  return ["Yes","No"];
}

function escapeJs(s){return String(s).replace(/['"]/g,'')}

function sanitizeTTS(s){return s.replace(/[^\w\s\-']/g,'')}

// Exams
function openExam(key){
  const exam = window.EXAMS[key];
  if(!exam){alert("Exam not found.");return;}
  currentExam = exam;
  examTitle.textContent = exam.title;
  examBody.innerHTML = exam.questions.map((q,i)=>renderExamQuestion(q,i)).join("");
  examModal.classList.remove('hidden');
}

function renderExamQuestion(q, idx){
  if(q.type==="mc"){
    return `<div class="exam-question" data-index="${idx}" data-key="${(q.key||'').toLowerCase()}">
      <h4>Q${idx+1}. ${q.q}</h4>
      ${q.opts.map(o=>`
        <label style="display:block;margin:4px 0;">
          <input type="radio" name="q${idx}" value="${o.toLowerCase()}"/> ${o}
        </label>
      `).join("")}
    </div>`;
  }
  if(q.type==="fill"){
    return `<div class="exam-question" data-index="${idx}" data-key="${(q.key||'').toLowerCase()}">
      <h4>Q${idx+1}. ${q.q}</h4>
      <input type="text" placeholder="Type your answer"/>
    </div>`;
  }
  if(q.type==="short"){
    return `<div class="exam-question" data-index="${idx}">
      <h4>Q${idx+1}. ${q.q}</h4>
      <textarea rows="3" placeholder="Write your answer"></textarea>
    </div>`;
  }
  if(q.type==="match"){
    // show pairs to match mentally; reveal answers later
    return `<div class="exam-question" data-index="${idx}">
      <h4>Q${idx+1}. ${q.q}</h4>
      <div class="text">${q.pairs.map(p=>`<div>â€¢ ${p[0]} â€” ${p[1]}</div>`).join("")}</div>
    </div>`;
  }
  return "";
}

function gradeExam(){
  if(!currentExam) return;
  const questions = examBody.querySelectorAll('.exam-question');
  let score = 0;
  let total = 0;
  questions.forEach(q=>{
    const key = (q.dataset.key||"").trim();
    const radios = q.querySelectorAll('input[type="radio"]');
    const input = q.querySelector('input[type="text"]');
    if(radios.length){
      total++;
      const chosen = [...radios].find(r=>r.checked);
      if(chosen && chosen.value===key){
        score++;
        q.classList.add('correct');
      }else{
        q.classList.add('incorrect');
      }
    }else if(input){
      total++;
      const val = (input.value||"").trim().toLowerCase();
      if(val===key){
        score++;
        q.classList.add('correct');
      }else{
        q.classList.add('incorrect');
      }
    }else{
      // short or match: not auto graded
    }
  });
  alert(`Auto-graded part: ${score} / ${total}. Short/match questions are not auto-graded.`);
}

function showExamAnswers(){
  if(!currentExam) return;
  const questions = examBody.querySelectorAll('.exam-question');
  questions.forEach((q,i)=>{
    const key = (q.dataset.key||"").trim();
    if(key){
      const ans = document.createElement('div');
      ans.style.marginTop = '6px';
      ans.style.color = '#bde8ff';
      ans.innerHTML = `<b>Answer:</b> ${key}`;
      q.appendChild(ans);
    }
  });
}

// Verbs
function renderVerbs(){
  verbsBody.innerHTML = window.IRREGULAR_VERBS.map(v=>`
    <div class="verb-card">
      <div class="verb-head">
        <div class="forms">${v.base} â†’ ${v.past}</div>
        <div class="actions">
          <button class="btn small" onclick="pronounce('${sanitizeTTS(v.base)}')">ğŸ”Š base</button>
          <button class="btn small" onclick="pronounce('${sanitizeTTS(v.past)}')">ğŸ”Š past</button>
        </div>
      </div>
      <div class="verb-ex">
        <div><b>Example (EN):</b> ${v.exEn}</div>
        <div><b>Ù…Ø«Ø§Ù„ (FA):</b> ${v.exFa}</div>
      </div>
    </div>
  `).join("");
}
/* extras.css */

.muted{color:#9bb3cc}
.lesson-btn.pulse:hover{filter:brightness(1.08)}
.exam-btn.glow:hover{filter:brightness(1.08)}
.page .section:hover{box-shadow:0 0 0 1px #2f4577 inset}
.page h2{color:#cfe7ff;border-bottom:1px solid #253a65;padding-bottom:6px}
